---
title: "College Outcomes Analysis"
author: "Richard Decal"
date: "October 26, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries  
```{r}
library(dplyr)
library(purrr)
library(data.table)
```

## Set working directory  
```{r}
# double check that this puts you in the right dir
project.dir <- getwd()
setwd(project.dir)
dataset.dir <- "Data"
outputs.dir <- "Output"
```


## Generate a list of files to be read in  
```{r}
file_names <- list.files(file.path(project.dir, dataset.dir), pattern="*.csv", full.names=TRUE) 
```


## Create function for reading in filename string
```{r}
extract_yr_from_fname <- function(fname) {
  l <- nchar(fname)
  start <- l-13
  end <- l-10
  year <- substr(fname, start, end)
  return(year)
}
file_years <- lapply(file_names, extract_yr_from_fname)
```



## Read in files and combine

The file reads in missing data as "NA", so we will coerce those entries into NA's.  

```{r}
fname_to_dtable <- function(filename){
    x <- fread(filename, skip=0, na.strings = c("NULL", ""))
    
    # append col called filename to x
      x <- mutate(x, Year=extract_yr_from_fname(filename))
      return(x)
}

# sends filenames to file reader func
#combined <- map_df(my.subset, read_my_files)
#lapply(my.subset, read_my_files)
#View(combined)
```

## Measuring completeness of each year

```{r}
calc_perc_goodcols_in_table <- function(dtable){
    na.max <- .2
    na.prop <- apply(dtable, 2, function(x) sum(is.na(x)/length(x)))
    percent_good <- (sum(na.prop < na.max)/length(dtable))
    return(percent_good)
}

score_fname_list <- function(fname_list){
    scores <- c()
    for (i in 1:length(fname_list)){
        f <- fname_list[i]
        tab <- fname_to_dtable(f)
        score <- calc_perc_goodcols_in_table(tab)
        cat("\n yr", extract_yr_from_fname(f), "score", score)
        scores[i] <- score
  }
  return(scores)
}

file_scores <- score_fname_list(fname_list = file_names)
cat("the best year is", max(file_scores))
```
The year 2013 is the best year in terms of % of total columns which have at most 20% NA values.

## Loading 2013 values to table
```{r}
d2013 <- fname_to_dtable(file_names[18])
```


## Calculating column-wise NA percent
```{r}
filter_NA_cols <- function(dtable){
    na.max <- .2
    na.prop <- apply(dtable, 2, function(x) sum(is.na(x)/length(x)))
    good_cols <- na.prop < na.max
    return(dtable[,good_cols])
}

d2013 <- filter_NA_cols(d2013)

(calc_completeness_percent(d2013))
```

## Clean data & only keep variables of interest 

## YOU CAN FILTER WHATEVER YOU WANT OUT OF THE DATA FRAME BY PUTTING
YOUR PARAMTERS INTO SELECT   

select(starts_with"blah blah text of innerest")

like say I wanted to select the column variable named institutiotion 
I would put the select function 
select(INSTNM)
```{r}
# cleaning the combined tables
#processed_frame <- combined %>%
 # mutate(year = map_chr(Filename, extract_yr_from_fname, 2)) #%>% 
  
  # add your filtering / desired columns
 # select(starts_with("INSTNM"))
  #select(-starts_with("HC02")) %>% 
  #select(-starts_with("HC03"))
#View(processed_frame)
select(processed_frame, starts_with("year"))
```


## Write the desired dataframe into csv  
```{r}
write_csv(processed_frame, "processed_college_outcomes.csv")
```