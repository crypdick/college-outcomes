---
title: "College Outcomes Analysis"
author: "Stephanie Rivera, Xiaotai Chai, Fanny Chow, Richard Decal"
subtitle: "Data Munging & EDA"
date: "October 26, 2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, comment = NA, comment="", prompt=FALSE)
```

`r knitr::opts_chunk$set(cache=TRUE)`  

# Introduction  
With over 1400 four-year institutions in the United States, students consider many factors when deciding where to attend college. The College Scorecard aims to help students, parents, and counselors make an informed choice on college choice. 


# Data  




## Load libraries  
```{r}
library(tidyverse)
library(purrr)
library(data.table)
```

## Set working directory  
```{r}
# double check that this puts you in the right dir
project.dir <- getwd()
setwd(project.dir)
dataset.dir <- "Data"
outputs.dir <- "Output"
```


## Generate a list of files to be read in  
```{r}
file_names <- list.files(file.path(project.dir, dataset.dir), pattern="*.csv", full.names=TRUE) 
```


## Create function for reading in filename string
```{r}
extract_yr_from_fname <- function(fname) {
  l <- nchar(fname)
  start <- l-13
  end <- l-10
  year <- substr(fname, start, end)
  return(year)
}
file_years <- lapply(file_names, extract_yr_from_fname)
```



## Read in files and combine

The file reads in missing data as "NA", so we will coerce those entries into NA's.  

```{r}
fname_to_dtable <- function(filename){
    x <- fread(filename, skip=0, na.strings = c("NULL", ""))
    
    # append col called filename to x
      x <- mutate(x, Year=extract_yr_from_fname(filename))
      return(x)
}

# sends filenames to file reader func
#combined <- map_df(my.subset, read_my_files)
#lapply(my.subset, read_my_files)
#View(combined)
```

## Measuring completeness of each year

Used a heatmap to visualize missing data in 3 random files. 
```{r}
data_1996 <- fname_to_dtable(file_names[1])

data2009 <- fname_to_dtable(file_names[13])

data2015 <- fname_to_dtable(file_names[20])

ratio_missing <- function(frame){
  ratiomissing <- c()
  for (i in 1:ncol(frame)){
  
  ratiomissing[i] <- sum(is.na(frame[,i]))/length(frame[,i])
  
  }
  return(ratiomissing)
}

ratio_1996 <- (ratio_missing(data_1996))
ratio_2009 <- (ratio_missing(data2009))
ratio_2015 <- (ratio_missing(data2015))

B <- matrix(c(ratio_1996,ratio_2009,ratio_2015), nrow=3,ncol=1777)
B1 <- t(B)
colnames(B1) <- c("1996","2009","2015")
dater <- data.matrix(B1)
collegedata_heatmap <- heatmap(dater, Rowv=NA, Colv=NA, col = heat.colors(256), scale="column", margins=c(5,10))
```


```{r}
calc_perc_goodcols_in_table <- function(dtable){
    na.max <- .2
    na.prop <- apply(dtable, 2, function(x) sum(is.na(x)/length(x)))
    percent_good <- (sum(na.prop < na.max)/length(dtable))
    return(percent_good)
}

score_fname_list <- function(fname_list){
    scores <- c()
    for (i in 1:length(fname_list)){
        f <- fname_list[i]
        tab <- fname_to_dtable(f)
        score <- calc_perc_goodcols_in_table(tab)
        cat("\n yr", extract_yr_from_fname(f), "score", score)
        scores[i] <- score
  }
  return(scores)
}

file_scores <- score_fname_list(fname_list = file_names)
cat("the best year is", max(file_scores))
```
The year 2013 is the best year in terms of % of total columns which have at most 20% NA values.

## Loading 2013 values to table
```{r}
d2013 <- fname_to_dtable(file_names[18])
```


## Calculating column-wise NA percent
```{r}
filter_NA_cols <- function(dtable){
    na.max <- .2
    na.prop <- apply(dtable, 2, function(x) sum(is.na(x)/length(x)))
    good_cols <- na.prop < na.max
    return(dtable[,good_cols])
}

d2013 <- filter_NA_cols(d2013)

(calc_perc_goodcols_in_table(d2013))

# optionally, save a snapshot of the filtered 2013 dtable
#write_csv(d2013, "filtered_2013.csv")
```

## Clean data & only keep variables of interest 

select(starts_with"blah blah text of innerest")

like say I wanted to select the column variable named institutiotion 
I would put the select function 
select(INSTNM)
```{r}
# cleaning the combined tables
#processed_frame <- combined %>%
 # mutate(year = map_chr(Filename, extract_yr_from_fname, 2)) #%>% 
  
  # add your filtering / desired columns
 # select(starts_with("INSTNM"))
  #select(-starts_with("HC02")) %>% 
  #select(-starts_with("HC03"))
#View(processed_frame)
#select(processed_frame, starts_with("year"))
ncf_row <- d2013 %>% filter(INSTNM == "New College of Florida")
```


## Write the desired dataframe into csv  
```{r}
#write_csv(d2013, "filtered_2013.csv")
```